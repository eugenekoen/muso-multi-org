<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=0.75" />
    <link rel="shortcut icon" href="./../../style/images/LOGO.jpg" />
    <link rel="stylesheet" type="text/css" href="./../../style/song.css">
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,400i,500,500i,600" rel="stylesheet">


    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script type="text/javascript" src="../jquery/jquery.min.js"></script>
    <script type="text/javascript" src="../jquery/jquery.transposer.js"></script>
    <title>Song</title>
</head>

<body>
    <pre id="songContent">
    <!-- Content will be injected here by script -->
  </pre>

    <script>
        // Updated credentials to match supabaseClient.js
        const SUPABASE_URL = 'https://xikllcuwvyuqcvcjjimw.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhpa2xsY3V3dnl1cWN2Y2pqaW13Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg4NjkyMTYsImV4cCI6MjA4NDQ0NTIxNn0.DqAsJ2BXAzwnggId0nMihzfxN9UpslAUQzm-V5sgfWY';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        document.addEventListener('DOMContentLoaded', async function ()
        {
            const preElement = document.getElementById('songContent');
            preElement.textContent = "Loading song...";

            const params = new URLSearchParams(window.location.search);
            const songIdentifier = params.get('song');
            const contentType = params.get('contentType');
            const targetKey = params.get('targetKey');
            const shouldHideTranspose = params.get('hideTranspose');

            if (!songIdentifier || !contentType)
            {
                console.error("Missing song identifier or content type in the URL.");
                preElement.textContent = "Error: Song not specified in the URL.";
                return;
            }

            if (shouldHideTranspose === 'true')
            {
                const style = document.createElement('style');
                style.innerHTML = '.transpose-keys { display: none !important; }';
                document.head.appendChild(style);
            }

            try
            {
                const columnName = contentType === 'chords' ? 'chords_content' : 'lyrics_content';

                // --- MODIFICATION: Ensure auth session is ready before querying ---
                const { data: { session } } = await supabaseClient.auth.getSession();

                // --- MODIFICATION 1: Request 'display_name' along with the content ---
                const { data, error } = await supabaseClient
                    .from('songs')
                    .select(`${columnName}, display_name`) // Ask for both columns
                    .eq('song_identifier', songIdentifier)
                    .maybeSingle(); // Use maybeSingle to avoid 406 errors

                if (error) throw error;

                if (!data || !data[columnName])
                {
                    preElement.textContent = `Error: Could not find ${contentType} for song '${songIdentifier}'.`;
                    return;
                }

                // --- MODIFICATION 2: Set the document title using the fetched display_name ---
                // We do this right away, replacing the old title-parsing logic.
                document.title = data.display_name || "Song";

                let songContent = data[columnName];
                let lines = songContent.split('\n');

                // This logic now ONLY needs to find the key for the transposer, not the title.
                let key = "C"; // Default key
                let contentStartIndex = 0;

                for (let i = 0; i < lines.length; i++)
                {
                    const trimmedLine = lines[i].trim();
                    if (trimmedLine !== '')
                    {
                        // Check if the first non-empty line is a key
                        if (/^[A-G][b#]?$/.test(trimmedLine))
                        {
                            key = trimmedLine;
                            contentStartIndex = i + 1; // Content starts after key
                        } else
                        {
                            // If not a key, this line is the start of the content
                            contentStartIndex = i;
                        }
                        break; // Stop after processing the first non-empty line
                    }
                }

                preElement.textContent = lines.slice(contentStartIndex).join('\n');

                const finalKey = key; // Always use original key for initialization
                preElement.setAttribute('data-key', finalKey);

                // The document title is already set above, so the old line here is removed.

                $('#songContent').transpose();

                // Auto-transpose to target key if specified and different from original
                if (targetKey && targetKey !== key)
                {
                    const transposeLinks = document.querySelectorAll('.transpose-keys a');
                    for (let link of transposeLinks)
                    {
                        if (link.textContent.trim() === targetKey)
                        {
                            link.click();
                            break;
                        }
                    }
                }

            } catch (err)
            {
                console.error("Error fetching song content:", err);
                preElement.textContent = `Error: Failed to load song data. Please check the console for details.`;
            }
        });
    </script>
</body>

</html>