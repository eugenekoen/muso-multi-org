<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=0.75" />
    <link rel="shortcut icon" href="./../../style/images/LOGO.jpg" />
    <link rel="stylesheet" type="text/css" href="./../../style/song.css">
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,400i,500,500i,600" rel="stylesheet">


    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script type="text/javascript" src="../jquery/jquery.min.js"></script>
    <script type="text/javascript" src="../jquery/jquery.transposer.js"></script>
    <title>Song</title>
</head>

<body>
    <pre id="songContent">
    <!-- Content will be injected here by script -->
  </pre>

    <script>
        // Updated credentials to match supabaseClient.js
        const SUPABASE_URL = 'https://xikllcuwvyuqcvcjjimw.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhpa2xsY3V3dnl1cWN2Y2pqaW13Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg4NjkyMTYsImV4cCI6MjA4NDQ0NTIxNn0.DqAsJ2BXAzwnggId0nMihzfxN9UpslAUQzm-V5sgfWY';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        const OFFLINE_CACHE_TTL_MS = 12 * 60 * 60 * 1000;

        function getSongCacheKey(orgId, songIdentifier)
        {
            return `cachedSong_${orgId}_${songIdentifier}`;
        }

        function readSongCache(orgId, songIdentifier)
        {
            if (!orgId || !songIdentifier) return null;
            const cacheKey = getSongCacheKey(orgId, songIdentifier);
            const cachedData = localStorage.getItem(cacheKey);
            if (!cachedData) return null;
            try
            {
                return JSON.parse(cachedData);
            } catch (e)
            {
                console.warn('Invalid cached song data', e);
                return null;
            }
        }

        function writeSongCache(orgId, songIdentifier, displayName, contentType, content, cachedEntry)
        {
            if (!orgId || !songIdentifier) return;
            const now = Date.now();
            const cachePayload = {
                songIdentifier: songIdentifier,
                displayName: displayName || (cachedEntry ? cachedEntry.displayName : ''),
                chordsContent: cachedEntry?.chordsContent || '',
                lyricsContent: cachedEntry?.lyricsContent || '',
                cachedAt: now,
                expiresAt: now + OFFLINE_CACHE_TTL_MS
            };

            if (contentType === 'chords')
            {
                cachePayload.chordsContent = content || '';
            } else
            {
                cachePayload.lyricsContent = content || '';
            }

            localStorage.setItem(getSongCacheKey(orgId, songIdentifier), JSON.stringify(cachePayload));
        }

        function getCachedContent(cachedEntry, contentType)
        {
            if (!cachedEntry) return null;
            return contentType === 'chords' ? cachedEntry.chordsContent : cachedEntry.lyricsContent;
        }

        function renderSongContent(preElement, songContent, contentType, displayName, targetKey)
        {
            document.title = displayName || 'Song';

            let lines = songContent.split('\n');

            let key = 'C';
            let contentStartIndex = 0;

            for (let i = 0; i < lines.length; i++)
            {
                const trimmedLine = lines[i].trim();
                if (trimmedLine !== '')
                {
                    if (/^[A-G][b#]?$/.test(trimmedLine))
                    {
                        key = trimmedLine;
                        contentStartIndex = i + 1;
                    } else
                    {
                        contentStartIndex = i;
                    }
                    break;
                }
            }

            preElement.textContent = lines.slice(contentStartIndex).join('\n');

            const finalKey = key;
            preElement.setAttribute('data-key', finalKey);

            $('#songContent').transpose();

            if (contentType === 'chords' && targetKey && targetKey !== key)
            {
                const transposeLinks = document.querySelectorAll('.transpose-keys a');
                for (let link of transposeLinks)
                {
                    if (link.textContent.trim() === targetKey)
                    {
                        link.click();
                        break;
                    }
                }
            }
        }

        document.addEventListener('DOMContentLoaded', async function ()
        {
            const preElement = document.getElementById('songContent');
            preElement.textContent = "Loading song...";

            const params = new URLSearchParams(window.location.search);
            const songIdentifier = params.get('song');
            const contentType = params.get('contentType');
            const orgId = params.get('org');
            const targetKey = params.get('targetKey');
            const shouldHideTranspose = params.get('hideTranspose');

            if (!songIdentifier || !contentType)
            {
                console.error("Missing song identifier or content type in the URL.");
                preElement.textContent = "Error: Song not specified in the URL.";
                return;
            }

            if (shouldHideTranspose === 'true')
            {
                const style = document.createElement('style');
                style.innerHTML = '.transpose-keys { display: none !important; }';
                document.head.appendChild(style);
            }

            const cachedEntry = readSongCache(orgId, songIdentifier);
            const cachedContent = getCachedContent(cachedEntry, contentType);
            const cacheIsFresh = !!(cachedEntry && cachedEntry.expiresAt && cachedEntry.expiresAt > Date.now());

            if (cacheIsFresh && cachedContent)
            {
                renderSongContent(preElement, cachedContent, contentType, cachedEntry.displayName, targetKey);
                return;
            }

            try
            {
                const columnName = contentType === 'chords' ? 'chords_content' : 'lyrics_content';

                await supabaseClient.auth.getSession();

                const { data, error } = await supabaseClient
                    .from('songs')
                    .select(`${columnName}, display_name`)
                    .eq('song_identifier', songIdentifier)
                    .eq('organization_id', orgId)
                    .maybeSingle();

                if (error) throw error;

                if (!data || !data[columnName])
                {
                    preElement.textContent = `Error: Could not find ${contentType} for song '${songIdentifier}'.`;
                    return;
                }

                const displayName = data.display_name || 'Song';
                const songContent = data[columnName];

                writeSongCache(orgId, songIdentifier, displayName, contentType, songContent, cachedEntry);
                renderSongContent(preElement, songContent, contentType, displayName, targetKey);

            } catch (err)
            {
                console.error('Error fetching song content:', err);
                if (cachedContent)
                {
                    renderSongContent(preElement, cachedContent, contentType, cachedEntry.displayName, targetKey);
                } else
                {
                    preElement.textContent = 'Error: Failed to load song data. Please check your connection.';
                }
            }
        });
    </script>
</body>

</html>